version: '3'
#***************************************************************
# integration level test agents                                *
#***************************************************************

services:
  #*************************************************************
  # Resolver: accepts didcomm did-resolve messages, makes http *
  # calls to resolvers to resolve dids, and sends results to   *
  # requesting agent using didcomm messages.                   *
  #*************************************************************

  resolver:
    image: didcomm-resolver-testing
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - "./acapy_resolver_mocked_github/__init__.py:/home/indy/aries-acapy-plugin-didcomm-resolver/didcomm_resolver/__init__.py"
      - "./acapy_resolver_mocked_github/resolver_mock.py:/home/indy/aries-acapy-plugin-didcomm-resolver/didcomm_resolver/resolver_mock.py"

    command: start --arg-file default.yml --plugin didcomm_resolver -e http://resolver:3000

  #*************************************************************
  # Requester: requests did resolution from resolver using     *
  # didcomm messages.                                          *
  #*************************************************************

  requester:
    image: didcomm-resolver-testing
    volumes:
      - "./acapy_resolver_mocked_github/resolver_mock.py:/home/indy/aries-acapy-plugin-didcomm-resolver/didcomm_resolver/resolver_mock.py"
      - "./acapy_resolver_mocked_github/__init__.py:/home/indy/aries-acapy-plugin-didcomm-resolver/didcomm_resolver/__init__.py"

    command: start --arg-file default.yml --plugin didcomm_resolver -e http://requester:3000

  #*************************************************************
  # tester: drives tests for didcomm_resolver in a             *
  # "Juggernaut" fashion!                                      *
  #*************************************************************

  tests:
      container_name: juggernaut
      build:
        context: .
        dockerfile: Dockerfile.test.runner
      environment:
        - WAIT_BEFORE_HOSTS=3
        - WAIT_HOSTS=requester:3000, resolver:3000
        - WAIT_HOSTS_TIMEOUT=60
        - WAIT_SLEEP_INTERVAL=1
        - WAIT_HOST_CONNECT_TIMEOUT=30
      depends_on:
        - resolver
        - requester
      command: sh -c "/wait && pytest -v"
